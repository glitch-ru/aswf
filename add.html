<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É</title>
<style>
body { font-family: Arial; max-width: 500px; margin: 30px auto; }
input, button { width: 100%; padding: 10px; margin: 6px 0; }
</style>
</head>
<body>

<h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É</h2>

<input id="token" type="password" placeholder="GitHub Personal Access Token">
<input id="shortCode" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: abc12)">
<input id="fullUrl" placeholder="–ü–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ (https://...)">

<button onclick="addLink()">–î–æ–±–∞–≤–∏—Ç—å</button>

<div id="msg" style="margin-top:15px;font-weight:bold"></div>

<script>
async function addLink() {
    const token = document.getElementById("token").value.trim();
    const code = document.getElementById("shortCode").value.trim();
    const url  = document.getElementById("fullUrl").value.trim();
    const msg  = document.getElementById("msg");

    if (!token || !code || !url) {
        msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!";
        return;
    }

    // üîπ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    const repo = "glitch-ru/aswf";
    const branch = "main";
    const path = "db.json";

    const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;

    try {
        // 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
        const res = await fetch(apiUrl, {
            headers: {
                "Authorization": "token " + token,
                "Accept": "application/vnd.github.v3+json"
            }
        });
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ GET: " + res.status);

        const data = await res.json();

        // 2Ô∏è‚É£ –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const content = atob(data.content.replace(/\n/g, ''));
        const db = JSON.parse(content);

        // 3Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
        db[code] = url;

        // 4Ô∏è‚É£ –ö–æ–¥–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ base64
        const updatedContent = btoa(JSON.stringify(db, null, 2));

        // 5Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PUT
        const putRes = await fetch(apiUrl, {
            method: "PUT",
            headers: {
                "Authorization": "token " + token,
                "Accept": "application/vnd.github.v3+json"
            },
            body: JSON.stringify({
                message: `Add/update short link: ${code}`,
                content: updatedContent,
                sha: data.sha,
                branch: branch
            })
        });

        if (putRes.ok) {
            msg.textContent = "–°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –ö–æ–¥: " + code;
        } else {
            const putData = await putRes.json();
            msg.textContent = "–û—à–∏–±–∫–∞ PUT: " + JSON.stringify(putData);
        }

    } catch (e) {
        msg.textContent = "–û—à–∏–±–∫–∞: " + e.message;
    }
}
</script>

</body>
</html>
